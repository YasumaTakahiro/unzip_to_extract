# アーカイブ操作ツール

7-Zipを使用してアーカイブファイルの解凍と圧縮を行うためのバッチファイルとPowerShellスクリプトです。

## 機能

### 解凍機能（unarchive）

- ZIP、7z、gzip、bzip2、tar、wim、xzなど、7-Zipが対応する様々な形式のアーカイブを解凍
- アーカイブ内のルートフォルダの有無を自動判定
- ルートフォルダがある場合：そのまま解凍
- ルートフォルダがない場合：アーカイブファイル名のフォルダを作成して解凍
- 同名フォルダが存在する場合：日時を付与したフォルダ名で解凍
- JSONC設定ファイルによる設定管理
- Windows環境変数の使用に対応
- 解凍先フォルダが指定されていない場合：アーカイブファイルと同じ階層に解凍

### 圧縮機能（archive）

- ZIP、7z、gzip、bzip2、tar、wim、xzなど、7-Zipが対応する様々な形式で圧縮
- 設定ファイルで圧縮形式を指定可能
- パスワード保護に対応
- ファイルを圧縮する場合：ファイル名と同じ名前のフォルダを作成し、その中にファイルを配置してから圧縮
- 同名のアーカイブファイルが存在する場合：日時を付与したファイル名で圧縮
- 圧縮先フォルダが指定されていない場合：圧縮対象と同じ階層に圧縮

## ファイル構成

```
7-zip_helper/
├── unarchive.bat                 # 解凍用バッチファイル（エントリーポイント）
├── unarchive.ps1                 # 解凍用PowerShellスクリプト（メイン処理）
├── archive.bat                   # 圧縮用バッチファイル（エントリーポイント）
├── archive.ps1                   # 圧縮用PowerShellスクリプト（メイン処理）
├── archive_config.jsonc          # 設定ファイル（解凍・圧縮共通）
└── README.md                     # このファイル
```

## 使用方法

### 解凍の基本的な使い方

**推奨方法：ファイルの関連付け設定**

1. アーカイブファイル（ZIP、7zなど）を右クリック
2. 「プログラムから開く」→「別のプログラムを選択」を選択
3. `unarchive.bat`を選択し、「常にこのアプリを使って.7zファイルを開く」にチェックを入れる
4. これで、アーカイブファイルをダブルクリックするだけで自動的に解凍されます

**代替方法：ドラッグ&ドロップ**

アーカイブファイル（ZIP、7zなど）を`unarchive.bat`にドラッグ&ドロップするだけです。

### 圧縮の基本的な使い方

**推奨方法：「送る」メニューに登録**

1. Windowsキー + R を押して「ファイル名を指定して実行」を開く
2. `shell:sendto` と入力してEnterキーを押す（「送る」フォルダが開きます）
3. `archive.bat`のショートカットを作成し、「送る」フォルダに配置する
4. これで、ファイルやフォルダを右クリック→「送る」→「archive.bat」で圧縮できます

**代替方法：ドラッグ&ドロップ**

ファイルまたはフォルダを`archive.bat`にドラッグ&ドロップするだけです。

### 設定ファイルの編集

`archive_config.jsonc`ファイルを編集して、7-Zipのパスや各種設定を変更します。

```jsonc
{
  // 7-Zipのインストールディレクトリ（環境変数を使用可能）
  "zipExeDir": "%PROGRAMFILES%\\7-Zip",
  
  // 解凍先フォルダ（環境変数を使用可能、空の場合はアーカイブファイルと同じ階層に解凍）
  "destDir": "%USERPROFILE%\\Downloads",
  
  // 圧縮先フォルダ（環境変数を使用可能、空の場合は圧縮対象と同じ階層に圧縮）
  "compressDestDir": "",
  
  // 圧縮時のパスワード（オプション、設定しない場合はパスワードなしで圧縮）
  "password": "",
  
  // 圧縮形式（7z, zip, gzip, bzip2, tar, wim, xz など、デフォルト: zip）
  "compressFormat": "zip",
  
  // 実行後コンソールが閉じるまでの待機時間（ミリ秒、デフォルト: 3000）
  "closeDelayMs": 3000
}
```

#### 設定項目の説明

- **zipExeDir**: 7-Zipのインストールディレクトリを指定します。このディレクトリ内に`7z.exe`が存在する必要があります。
- **destDir**: 解凍先フォルダを指定します。空の場合は、アーカイブファイルと同じ階層に解凍されます。
- **compressDestDir**: 圧縮先フォルダを指定します。空の場合は、圧縮対象と同じ階層に圧縮されます。
- **password**: 圧縮時のパスワードを指定します。空の場合はパスワードなしで圧縮されます。
- **compressFormat**: 圧縮形式を指定します。対応形式：`7z`, `zip`, `gzip`, `bzip2`, `tar`, `wim`, `xz`。デフォルトは`zip`です。
- **closeDelayMs**: 実行後、コンソールが自動的に閉じるまでの待機時間をミリ秒で指定します。デフォルトは`3000`（3秒）です。`0`を指定すると待機しません。

#### 環境変数の使用

Windowsの環境変数を使用できます。以下のような環境変数が使用可能です：

- `%PROGRAMFILES%` - プログラムファイルフォルダ（例: `C:\Program Files`）
- `%USERPROFILE%` - ユーザープロファイルフォルダ（例: `C:\Users\username`）
- `%HOMEPATH%` - ホームパス（例: `\Users\username`）
- `%TEMP%` - 一時フォルダ
- `%APPDATA%` - アプリケーションデータフォルダ
- その他のWindows環境変数

#### コメントの使用

JSONC形式のため、コメントを追加できます：

```jsonc
{
  // 行コメント
  "zipExeDir": "%PROGRAMFILES%\\7-Zip",
  
  /* 
   * ブロックコメント
   * 複数行にわたる説明を記述できます
   */
  "destDir": "%USERPROFILE%\\Downloads"
}
```

## 動作の詳細

### 解凍機能の動作

#### ルートフォルダの判定

アーカイブファイル内の構造を確認し、ルートフォルダの有無を自動判定します：

- **ルートフォルダがある場合**: 解凍先に直接解凍します
  - 例: `archive.zip`（中身: `folder\file.txt`）→ `解凍先\folder\file.txt`
  
- **ルートフォルダがない場合**: アーカイブファイル名のフォルダを作成して解凍します
  - 例: `archive.zip`（中身: `file1.txt`, `file2.txt`）→ `解凍先\archive\file1.txt`, `解凍先\archive\file2.txt`

#### 同名フォルダの処理

解凍先に同名のフォルダが既に存在する場合：

- 警告メッセージを表示
- フォルダ名に日時を付与（形式: `フォルダ名_yyyyMMdd_HHmmss`）
- 新しいフォルダ名で解凍

例: `archive`フォルダが既に存在する場合 → `archive_20251211_143025`として解凍

#### 解凍先フォルダの指定

- **設定ファイルで指定されている場合**: 指定されたフォルダに解凍（フォルダが存在しない場合はエラー）
- **設定ファイルが空の場合**: アーカイブファイルと同じ階層に解凍

### 圧縮機能の動作

#### 圧縮形式の指定

設定ファイルの`compressFormat`で圧縮形式を指定できます。指定した形式に応じて、適切な拡張子が自動的に付与されます：

- `7z` → `.7z`
- `zip` → `.zip`
- `gzip` → `.gz`
- `bzip2` → `.bz2`
- `tar` → `.tar`
- `wim` → `.wim`
- `xz` → `.xz`

#### ファイルの圧縮

ファイルを圧縮する場合、以下の処理が行われます：

1. ファイル名（拡張子除く）と同じ名前のフォルダを作成
2. ファイルをそのフォルダにコピー
3. フォルダを圧縮
4. 圧縮完了後、一時フォルダを削除

例: `document.pdf`を圧縮する場合 → `document`フォルダを作成し、その中に`document.pdf`を配置してから圧縮

#### 同名アーカイブファイルの処理

圧縮先に同名のアーカイブファイルが既に存在する場合：

- 警告メッセージを表示
- ファイル名に日時を付与（形式: `ファイル名_yyyyMMdd_HHmmss.拡張子`）
- 新しいファイル名で圧縮

例: `archive.zip`が既に存在する場合 → `archive_20251211_143025.zip`として圧縮

#### パスワード保護

設定ファイルの`password`にパスワードを指定すると、パスワード保護されたアーカイブファイルが作成されます。

#### 圧縮先フォルダの指定

- **設定ファイルで指定されている場合**: 指定されたフォルダに圧縮（フォルダが存在しない場合はエラー）
- **設定ファイルが空の場合**: 圧縮対象と同じ階層に圧縮

## エラーハンドリング

以下の場合にエラーが表示され、処理が停止します：

### 解凍時

- 7-Zipのディレクトリが存在しない
- 7-Zipのディレクトリ内に`7z.exe`が存在しない
- 解凍先フォルダが存在しない（設定ファイルで指定されている場合）
- アーカイブファイルが見つからない
- アーカイブファイルのリスト取得に失敗
- 解凍に失敗（パスワードが間違っている場合など）

### 圧縮時

- 7-Zipのディレクトリが存在しない
- 7-Zipのディレクトリ内に`7z.exe`が存在しない
- 圧縮先フォルダが存在しない（設定ファイルで指定されている場合）
- 圧縮対象が見つからない
- 圧縮に失敗

## 終了時の動作

- **正常終了時**: 設定ファイルの`closeDelayMs`で指定された時間（デフォルト: 3秒）後に自動的にコンソールを閉じます
- **エラー時**: `Enter`キーを押すまで待機します（エラーメッセージを確認するため）

## 要件

- Windows 10以降
- PowerShell 5.1以降
- 7-Zip（`7z.exe`が必要）

## トラブルシューティング

### 7-Zipが見つからない

設定ファイルの`zipExeDir`を確認してください。7-Zipのインストールディレクトリが正しく指定されているか確認してください。

### 解凍先フォルダが存在しない

設定ファイルの`destDir`で指定したフォルダが存在することを確認してください。存在しない場合は、事前にフォルダを作成するか、`destDir`を空にしてアーカイブファイルと同じ階層に解凍するように設定してください。

### 圧縮先フォルダが存在しない

設定ファイルの`compressDestDir`で指定したフォルダが存在することを確認してください。存在しない場合は、事前にフォルダを作成するか、`compressDestDir`を空にして圧縮対象と同じ階層に圧縮するように設定してください。

### 複数ファイルの圧縮について

このツールは複数のファイルを同時に圧縮することには対応していません。複数のファイルを1つのアーカイブにまとめたい場合は、事前にそれらのファイルを1つのフォルダに入れてから、そのフォルダを圧縮してください。

### 文字化けが発生する

7-Zipの出力はシステムのデフォルトコードページ（通常はShift-JIS）で出力されるため、一部の文字が文字化けする場合があります。これは7-Zipの仕様によるもので、機能には影響しません。

### パスワードが間違っている

解凍時にパスワードが間違っている場合、エラーメッセージが表示されます。正しいパスワードを確認してください。

## ライセンス

このツールは自由に使用・改変できます。
